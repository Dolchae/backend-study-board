<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œíŒ í…ŒìŠ¤íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">
<h1 class="text-center">ê²Œì‹œíŒ</h1>

<!-- ìƒˆ ê²Œì‹œê¸€ ì‘ì„± -->
<div class="card p-3 mb-3">
    <h2>ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</h2>
    <input type="text" id="title" class="form-control mb-2" placeholder="ì œëª©">
    <textarea id="content" class="form-control mb-2" placeholder="ë‚´ìš©"></textarea>
    <input type="text" id="memberUsername" class="form-control mb-2" placeholder="ì‘ì„±ì">
    <button class="btn btn-primary" id="create-board-btn">ê²Œì‹œê¸€ ë“±ë¡</button>
</div>

<!-- ê²Œì‹œê¸€ ëª©ë¡ -->
<h2>ê²Œì‹œê¸€ ëª©ë¡</h2>
<div id="board-list"></div>

<script>
    const API_BASE_URL = 'http://localhost:8080'; // ë°±ì—”ë“œ API ì£¼ì†Œ

    document.addEventListener("DOMContentLoaded", function () {
        console.log("ğŸš€ DOM ë¡œë“œ ì™„ë£Œ! ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹œì‘!");

        // ê²Œì‹œê¸€ ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
        document.getElementById("create-board-btn").addEventListener("click", createBoard);

        // ê²Œì‹œíŒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        fetchBoards();
    });

    async function fetchBoards() {
        const response = await fetch(`${API_BASE_URL}/board`);
        const boards = await response.json();

        const boardList = document.getElementById('board-list');
        boardList.innerHTML = '';

        boards.forEach(board => {
            const div = document.createElement('div');
            div.classList.add('card', 'mb-3', 'p-3');
            div.innerHTML = `
                    <h3>${board.title} <small class="text-muted">(${board.memberUsername})</small></h3>
                    <p>${board.content}</p>
                    <button class="btn btn-danger btn-sm delete-board" data-id="${board.id}">ì‚­ì œ</button>

                    <h5 class="mt-3">ëŒ“ê¸€</h5>
                    <div id="comment-list-${board.id}"></div>
                    <input type="text" id="comment-input-${board.id}" class="form-control mb-2" placeholder="ëŒ“ê¸€ ì…ë ¥">
                    <button class="btn btn-secondary btn-sm create-comment" data-id="${board.id}">ëŒ“ê¸€ ë“±ë¡</button>
                `;
            boardList.appendChild(div);

            fetchComments(board.id);
        });

        // ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelectorAll(".create-comment").forEach(button => {
            button.addEventListener("click", function () {
                const boardId = this.getAttribute("data-id");
                createComment(boardId);
            });
        });

        // ê²Œì‹œê¸€ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelectorAll(".delete-board").forEach(button => {
            button.addEventListener("click", function () {
                const boardId = this.getAttribute("data-id");
                deleteBoard(boardId);
            });
        });
    }

    async function createBoard() {
        const title = document.getElementById('title').value;
        const content = document.getElementById('content').value;
        const memberUsername = document.getElementById('memberUsername').value;

        const response = await fetch(`${API_BASE_URL}/board`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content, memberUsername })
        });

        if (response.ok) {
            fetchBoards();
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
        } else {
            alert("ê²Œì‹œê¸€ ë“±ë¡ ì‹¤íŒ¨");
        }
    }

    async function deleteBoard(id) {
        await fetch(`${API_BASE_URL}/board/${id}`, { method: 'DELETE' });
        fetchBoards();
    }

    async function fetchComments(boardId) {
        const response = await fetch(`${API_BASE_URL}/comment/${boardId}`);
        const comments = await response.json();

        const commentList = document.getElementById(`comment-list-${boardId}`);
        commentList.innerHTML = '';

        comments.forEach(comment => {
            const div = document.createElement('div');
            div.classList.add('border', 'p-2', 'mb-2');
            div.innerHTML = `
                    <strong>${comment.memberUsername}</strong>: ${comment.content}
                    <button class="btn btn-danger btn-sm ms-2 delete-comment" data-id="${comment.id}" data-board="${boardId}">ì‚­ì œ</button>
                `;
            commentList.appendChild(div);
        });

        // ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelectorAll(".delete-comment").forEach(button => {
            button.addEventListener("click", function () {
                const commentId = this.getAttribute("data-id");
                const boardId = this.getAttribute("data-board");
                deleteComment(commentId, boardId);
            });
        });
    }

    async function createComment(boardId) {
        console.log("ğŸ“ createComment() ì‹¤í–‰ë¨!");
        console.log("ğŸ“ ì…ë ¥ëœ boardId:", boardId);

        if (!boardId) {
            console.error("âŒ boardIdê°€ undefinedì…ë‹ˆë‹¤.");
            alert("ëŒ“ê¸€ì„ ë“±ë¡í•  ê²Œì‹œê¸€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const content = document.getElementById(`comment-input-${boardId}`).value;
        const memberUsername = document.getElementById("memberUsername").value;

        if (!content.trim()) {
            console.error("âŒ ëŒ“ê¸€ ë‚´ìš©ì´ ë¹„ì–´ ìˆìŒ!");
            alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/comment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, memberUsername, boardId })
            });

            console.log("ğŸ” ì‘ë‹µ ìƒíƒœ:", response.status);

            if (response.ok) {
                console.log("âœ… ëŒ“ê¸€ ë“±ë¡ ì„±ê³µ");
                fetchComments(boardId);
                document.getElementById(`comment-input-${boardId}`).value = '';
            } else {
                const errorText = await response.text();
                console.error("âŒ ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:", errorText);
                alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + errorText);
            }
        } catch (error) {
            console.error("ğŸš¨ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
            alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ! ë°±ì—”ë“œ ì‹¤í–‰ í™•ì¸ í•„ìš”");
        }
    }

    async function deleteComment(commentId, boardId) {
        console.log("ğŸ—‘ï¸ deleteComment() ì‹¤í–‰ë¨!");
        console.log("ğŸ—‘ï¸ ì‚­ì œí•  ëŒ“ê¸€ ID:", commentId);
        console.log("ğŸ—‘ï¸ ì†Œì† ê²Œì‹œê¸€ ID:", boardId);

        if (!commentId || !boardId) {
            console.error("âŒ commentId ë˜ëŠ” boardIdê°€ undefinedì…ë‹ˆë‹¤.");
            alert("ì‚­ì œí•  ëŒ“ê¸€ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/comment/delete/${commentId}`, {
                method: 'DELETE',
            });

            console.log("ğŸ” ì‘ë‹µ ìƒíƒœ:", response.status);

            if (response.ok) {
                console.log("âœ… ëŒ“ê¸€ ì‚­ì œ ì„±ê³µ");
                fetchComments(boardId);
            } else {
                const errorText = await response.text();
                console.error("âŒ ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:", errorText);
                alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨: " + errorText);
            }
        } catch (error) {
            console.error("ğŸš¨ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
            alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ! ë°±ì—”ë“œ ì‹¤í–‰ í™•ì¸ í•„ìš”");
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
