<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시판 테스트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">
<h1 class="text-center">게시판</h1>

<!-- 새 게시글 작성 -->
<div class="card p-3 mb-3">
    <h2>새 게시글 작성</h2>
    <input type="text" id="title" class="form-control mb-2" placeholder="제목">
    <textarea id="content" class="form-control mb-2" placeholder="내용"></textarea>
    <input type="text" id="memberUsername" class="form-control mb-2" placeholder="작성자">
    <button class="btn btn-primary" id="create-board-btn">게시글 등록</button>
</div>

<!-- 게시글 목록 -->
<h2>게시글 목록</h2>
<div id="board-list"></div>

<script>
    const API_BASE_URL = 'http://localhost:8080'; // 백엔드 API 주소

    document.addEventListener("DOMContentLoaded", function () {
        console.log("🚀 DOM 로드 완료! 이벤트 바인딩 시작!");

        // 게시글 등록 버튼 이벤트 추가
        document.getElementById("create-board-btn").addEventListener("click", createBoard);

        // 게시판 목록 불러오기
        fetchBoards();
    });

    async function fetchBoards() {
        const response = await fetch(`${API_BASE_URL}/board`);
        const boards = await response.json();

        const boardList = document.getElementById('board-list');
        boardList.innerHTML = '';

        boards.forEach(board => {
            const div = document.createElement('div');
            div.classList.add('card', 'mb-3', 'p-3');
            div.innerHTML = `
                    <h3>${board.title} <small class="text-muted">(${board.memberUsername})</small></h3>
                    <p>${board.content}</p>
                    <button class="btn btn-danger btn-sm delete-board" data-id="${board.id}">삭제</button>

                    <h5 class="mt-3">댓글</h5>
                    <div id="comment-list-${board.id}"></div>
                    <input type="text" id="comment-input-${board.id}" class="form-control mb-2" placeholder="댓글 입력">
                    <button class="btn btn-secondary btn-sm create-comment" data-id="${board.id}">댓글 등록</button>
                `;
            boardList.appendChild(div);

            fetchComments(board.id);
        });

        // 댓글 등록 버튼 이벤트 추가
        document.querySelectorAll(".create-comment").forEach(button => {
            button.addEventListener("click", function () {
                const boardId = this.getAttribute("data-id");
                createComment(boardId);
            });
        });

        // 게시글 삭제 버튼 이벤트 추가
        document.querySelectorAll(".delete-board").forEach(button => {
            button.addEventListener("click", function () {
                const boardId = this.getAttribute("data-id");
                deleteBoard(boardId);
            });
        });
    }

    async function createBoard() {
        const title = document.getElementById('title').value;
        const content = document.getElementById('content').value;
        const memberUsername = document.getElementById('memberUsername').value;

        const response = await fetch(`${API_BASE_URL}/board`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content, memberUsername })
        });

        if (response.ok) {
            fetchBoards();
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
        } else {
            alert("게시글 등록 실패");
        }
    }

    async function deleteBoard(id) {
        await fetch(`${API_BASE_URL}/board/${id}`, { method: 'DELETE' });
        fetchBoards();
    }

    async function fetchComments(boardId) {
        const response = await fetch(`${API_BASE_URL}/comment/${boardId}`);
        const comments = await response.json();

        const commentList = document.getElementById(`comment-list-${boardId}`);
        commentList.innerHTML = '';

        comments.forEach(comment => {
            const div = document.createElement('div');
            div.classList.add('border', 'p-2', 'mb-2');
            div.innerHTML = `
                    <strong>${comment.memberUsername}</strong>: ${comment.content}
                    <button class="btn btn-danger btn-sm ms-2 delete-comment" data-id="${comment.id}" data-board="${boardId}">삭제</button>
                `;
            commentList.appendChild(div);
        });

        // 댓글 삭제 버튼 이벤트 추가
        document.querySelectorAll(".delete-comment").forEach(button => {
            button.addEventListener("click", function () {
                const commentId = this.getAttribute("data-id");
                const boardId = this.getAttribute("data-board");
                deleteComment(commentId, boardId);
            });
        });
    }

    async function createComment(boardId) {
        console.log("📝 createComment() 실행됨!");
        console.log("📝 입력된 boardId:", boardId);

        if (!boardId) {
            console.error("❌ boardId가 undefined입니다.");
            alert("댓글을 등록할 게시글 정보를 찾을 수 없습니다.");
            return;
        }

        const content = document.getElementById(`comment-input-${boardId}`).value;
        const memberUsername = document.getElementById("memberUsername").value;

        if (!content.trim()) {
            console.error("❌ 댓글 내용이 비어 있음!");
            alert("댓글 내용을 입력해주세요.");
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/comment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, memberUsername, boardId })
            });

            console.log("🔍 응답 상태:", response.status);

            if (response.ok) {
                console.log("✅ 댓글 등록 성공");
                fetchComments(boardId);
                document.getElementById(`comment-input-${boardId}`).value = '';
            } else {
                const errorText = await response.text();
                console.error("❌ 댓글 등록 실패:", errorText);
                alert("댓글 등록 실패: " + errorText);
            }
        } catch (error) {
            console.error("🚨 네트워크 오류:", error);
            alert("네트워크 오류 발생! 백엔드 실행 확인 필요");
        }
    }

    async function deleteComment(commentId, boardId) {
        console.log("🗑️ deleteComment() 실행됨!");
        console.log("🗑️ 삭제할 댓글 ID:", commentId);
        console.log("🗑️ 소속 게시글 ID:", boardId);

        if (!commentId || !boardId) {
            console.error("❌ commentId 또는 boardId가 undefined입니다.");
            alert("삭제할 댓글 정보를 확인할 수 없습니다.");
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/comment/delete/${commentId}`, {
                method: 'DELETE',
            });

            console.log("🔍 응답 상태:", response.status);

            if (response.ok) {
                console.log("✅ 댓글 삭제 성공");
                fetchComments(boardId);
            } else {
                const errorText = await response.text();
                console.error("❌ 댓글 삭제 실패:", errorText);
                alert("댓글 삭제 실패: " + errorText);
            }
        } catch (error) {
            console.error("🚨 네트워크 오류:", error);
            alert("네트워크 오류 발생! 백엔드 실행 확인 필요");
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
